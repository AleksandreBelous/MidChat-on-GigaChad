<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>GigaChad Переговорщик</title>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #chat-container { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .message { margin-bottom: 15px; padding: 10px 15px; border-radius: 18px; max-width: 80%; line-height: 1.5; }
        .user { background-color: #3b82f6; color: white; align-self: flex-end; margin-left: auto; }
        .assistant { background-color: #374151; color: #f3f4f6; align-self: flex-start; }
        .system { background-color: #4b5563; color: #cbd5e1; font-style: italic; font-size: 0.9em; text-align: center; width: 100%; padding: 5px 0; }
        #controls { padding: 15px; border-top: 1px solid #374151; }
        #input-form { display: flex; }
        #input-text { flex-grow: 1; background-color: #374151; border: 1px solid #4b5563; border-radius: 8px; padding: 10px; color: white; font-size: 16px; }
        #actions-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .action-button { background-color: #4f46e5; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
        .system {
    text-align: center;
    font-style: italic;
    color: #888;
    font-size: 0.9em;
    margin-bottom: 10px;
}
    </style>
</head>
<body>
<div id="chat-container"></div>
<div id="controls">
    <form id="input-form">
        <input type="text" id="input-text" placeholder="Введите сообщение для свободной беседы..." autocomplete="off">
        <button type="submit">Отправить</button>
    </form>
    <div id="actions-container"></div>
</div>

<script>
    const chatContainer = document.getElementById('chat-container');
    const inputForm = document.getElementById('input-form');
    const inputText = document.getElementById('input-text');
    const actionsContainer = document.getElementById('actions-container');

    const API_URL = 'http://localhost:5001/api/chat';

    async function postToServer(payload) {
        actionsContainer.innerHTML = ''; // Очищаем кнопки
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error((await response.json()).error || 'Ошибка сети');

            const data = await response.json();
            addMessageToChat('assistant', data.response);
            renderActions(data.actions);
        } catch (error) {
            addMessageToChat('assistant', `Ошибка: ${error.message}`);
        }
    }

    function addMessageToChat(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', role);
        messageDiv.textContent = content;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function renderActions(actions = []) {
        actionsContainer.innerHTML = '';
        actions.forEach(action => {
            const button = document.createElement('button');
            button.textContent = action.label;
            button.classList.add('action-button');
            button.onclick = () => {
                addMessageToChat('system', `Выбрано действие: ${action.label}`);
                postToServer({ command: action.command });
            };
            actionsContainer.appendChild(button);
        });
    }

    inputForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const message = inputText.value.trim();
        if (message) {
            addMessageToChat('user', message);
            postToServer({ message: message });
            inputText.value = '';
        }
    });

    window.onload = async () => {
            try {
                const response = await fetch('http://localhost:5001/api/reset', { method: 'POST' });
                const data = await response.json();
                console.log('Session reset:', data.message);

                // После успешного сброса, запрашиваем первое сообщение и действия
                const initialResponse = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: "Начать сессию" }) // Отправляем стартовое сообщение
                });
                const initialData = await initialResponse.json();
                addMessageToChat('assistant', initialData.response);
                renderActions(initialData.actions);

            } catch (error) {
                addMessageToChat('assistant', `Ошибка сброса сессии: ${error.message}`);
            }
        };

    // Первый запуск
    // postToServer({ message: "Начать сессию" });
    // Вместо этого, просто выводим приветствие при загрузке
    //addMessageToChat('assistant', 'Здравствуйте! Я - MidChat, ваш модератор. Пожалуйста, представьте участников переговоров, написав их имена в поле ниже (пример: Александр, Мария).');
    //renderActions([
        // На старте кнопок нет
    //]);
</script>
</body>
</html>
